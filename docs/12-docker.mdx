--- 
title: Docker
toc_min_heading_level: 2
toc_max_heading_level: 3
---

import Link from '@docusaurus/Link';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import useBaseUrl from '@docusaurus/useBaseUrl';

# Running Gwen in Docker

Sometimes it may be useful to run Gwen in [Docker](https://www.docker.com/). For example, if you want to run Gwen in a [Jenkins](/docs/jenkins) pipeline on a build server or node agent.
Setting up Gwen to run in a [Selenoid](https://aerokube.com/selenoid/) container in Docker is describe here.

## Docker Setup

If you initialised your Gwen project directory using the [`gwen init`](/docs/cli#init-command) command with Gwen v3.16.0 or higher, you will already have all the necessary docker files ready and can skip straight to the [Yarn script](/docs/docker#yarn-script) section on this page. Otherwise you will need to create the following files manually.

### Dockerfile
Create a suitable docker image for Gwen to run in. It will need to have Java 8+, node 12+, bash and yarn installed (since we will be using yarn in the examples that follow).

To build your own image:

1. Create a new file named `Dockerfile` in the `gwen` directory of your project ([create a Gwen project](/docs/get-started) if you don't have one).

```shell {3}
./project                    # Your project root
 └── /gwen
     └──Dockerfile           # Docker image file
```

2. Save one of the following examples into the file. Which you choose is a matter of preference. If unsure, use the first one.

- Alpine Linux and Node base image with Open JDK 8 JRE installed:
```
# base alpine image with node
FROM node:17-alpine

# install bash and java
RUN apk update \
    && apk add bash \
    && apk add openjdk8-jre
```

- Or Red Hat Linux and Open JDK 8 base image with node installed:
```
# base Red Hat image with open JDK 8
FROM adoptopenjdk/openjdk8:ubi

# install node & yarn
RUN dnf module install nodejs:16 -y
RUN npm install --global yarn
```

### Docker compose file

Configure a `docker-compose.yml` file to create docker containers for Gwen and at least one web browser for it to run against. Here, we will use [Selenoid](https://aerokube.com/selenoid/) to stand up a chrome browser, video recorder, and Selenium hub that Gwen will connect to.

1. Create a new file named `docker-compose.yaml` in the in the `gwen` directory of your project of your project.

```shell {4}
./project                    # Your project root
 └── /gwen
     ├── Dockerfile              # Docker image file
     └── docker-compose.yml      # Docker compose YAML file
```

2. Save the following content into the file.

```yaml
version: '3.5'
services:
  chrome:
    image: selenoid/chrome:latest
    networks:
      - gwen-net
  firefox:
    image: selenoid/firefox:latest
    networks:
      - gwen-net
  edge:
    image: browsers/edge:latest
    networks:
      - gwen-net
  video-recorder:
    image: selenoid/video-recorder:latest-release
    networks:
      - gwen-net
  selenoid:
    depends_on:
      - chrome
      - firefox
      - edge
      - video-recorder
    image: aerokube/selenoid:latest-release
    networks:
      - gwen-net
    ports:
      - "4444:4444"
    volumes:
      - "$PWD/gwen/browsers:/etc/selenoid/:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "$PWD/gwen/output/.video:/opt/selenoid/video"
    environment:
      - OVERRIDE_VIDEO_OUTPUT=$PWD/gwen/output/.video
    command: ["-container-network", "gwen-net", "-video-output-dir", "/opt/selenoid/video"]
  gwen:
    depends_on:
      - selenoid
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SELENIUM_HUB=selenoid
      - NO_COLOR=1
      - GWEN_BROWSER
      - GWEN_DRY_RUN
      - GWEN_PARALLEL
      - GWEN_HEADLESS
    volumes:
      - "$PWD:/project"
    working_dir: /project
    command: bash -c "yarn install && yarn gwen:selenoid"
    networks:
      - gwen-net
networks:
  gwen-net:
    name: gwen-net
```

### Selenoid browsers file

1. Create a `browsers.json` file in the `gwen/browsers` directory of your project.

```shell {4}
./project                    # Your project root
 └── /gwen                   # Gwen working directory
     └── browsers
         └──browsers.json    # Selenoid browsers file
```

2. Save the following content into the file.

```json
{
  "chrome": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "selenoid/chrome:latest",
        "port": "4444",
        "path": "/"
      }
    }
  },
  "firefox": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "selenoid/firefox:latest",
        "port": "4444",
        "path": "/wd/hub"
      }
    }
  },
  "MicrosoftEdge": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "browsers/edge:latest",
        "port": "4444",
        "path": "/"
      }
    }
  }
}
```

### Gwen settings file

1. Create a `selenoid.conf` settings file in the `gwen/browsers` directory of your project.

```shell {5}
./project                    # Your project root
 └── /gwen                   # Gwen working directory
     └── browsers
         ├──browsers.json    # Selenoid browsers file
         └──selenoid.conf    # Selenoid Gwen settings
```

2. Save the following content into the file.

```json
gwen {
  video {
    dir = "${env.HOME}/.gwen/video"
  }
  web {
    capability {
      enableVNC = true
      enableVideo = false
      acceptSslCerts = true
    }
    remote {
      url = "http://${SELENIUM_HUB}:4444/wd/hub"
    }
  }
}
```

## Yarn script

Add the following `gwen:selenoid` script to the `scripts` section of the `package.json` file in your project, replacing `gwen/samples` with the directory containing the features you want to execute. 
This will be called by the `gwen` container in our `gwen/docker-compose.yml` file when it starts up.

```json {3}
"scripts": {
  "gwen": "gwen",
  "gwen:selenoid": "gwen -b -c gwen/browsers/selenoid.conf gwen/samples"
}
```

## Run Gwen in docker

1. Start your docker desktop (see [getting started with Docker](https://docs.docker.com/get-started/) for more info).

2. Create the Gwen output directory if it does not already exist.

```shell
mkdir -p gwen/output
```

3. Run the following command to build your docker image (once off).

```shell
docker-compose -f gwen/docker-compose.yml build
```

4. Run the following command in your project directory to spin everything up and launch Gwen in docker:

```shell
docker-compose -f gwen/docker-compose.yml run gwen
```

5. Tear it all down when done:

```shell
docker-compose -f gwen/docker-compose.yml down
```

### Video recordings

```json {5}
gwen {
  web {
    capability {
      ..
      enableVideo = true
      ..
    }
    ..
  }
}
```
If you set `gwen.web.capability.videoEnabled` to `true` in your *gwen/browsers/selenoid.conf* file, MP4 video recordings of each session will be attached to the feature level [HTML reports](/docs/reports/html). Set this to `false` if you do not wish to capture video.

:::note video settings
- [`gwen-video.dir`](/docs/settings/reference#gwen-video.dir) 
  - Should match host directory mounted to `/opt/selenoid/video` in Selenoid video-recorder
- [`gwen-video.timeoutSecs`](/docs/settings/reference#gwen-video.timeoutSecs) 
  - Time to wait for asyncronous video writes to complete (override only if default does not suffice)
:::

See also: [Video recordings](/docs/reports/video-recordings) 
