--- 
title: Docker
toc_min_heading_level: 2
toc_max_heading_level: 3
---

import Link from '@docusaurus/Link';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import useBaseUrl from '@docusaurus/useBaseUrl';

# Running Gwen in Docker

Sometimes it may be useful to run Gwen in [Docker](https://www.docker.com/). For example, if you want to run Gwen in a [Jenkins](/docs/jenkins) pipeline on a build server or node agent.
Setting up Gwen to run in a [Selenoid](https://aerokube.com/selenoid/) container in Docker is describe here.

## Package JSON script

Add the following `gwen:selenoid` script to the `scripts` section of the `package.json` file in your project, replacing `gwen/samples` with the directory containing the features you want to execute. 
This will be called by the `gwen` container that we will create and run in Docker.

```json {3}
"scripts": {
  "gwen": "gwen",
  "gwen:selenoid": "gwen -b -c gwen/browsers/selenoid.conf gwen/samples"
}
```

## Docker Setup

> Since [v3.16.0](https://github.com/gwen-interpreter/gwen-web/releases/tag/v3.16.0), the [`init --docker`](/docs/cli#gwen-cli-options-init-docker) command was introduced to generate Docker and Selenoid files in your project. You will need to create the files manually if you are using an older version.

<Tabs
  groupId="setup"
  defaultValue="project"
  values={[
    {label: 'Project', value: 'project'},
  ]}>

<TabItem value="project">

<Tabs
groupId="jstool"
defaultValue="yarn"
values={[
  {label: 'Yarn', value: 'yarn'},
  {label: 'npm', value: 'npm'},
  {label: 'pnpm', value: 'pnpm'}
]}>

<TabItem value="yarn">

Run the following command in the root of your project to generate all the necessary Docker and Selenoid files
  
  ```shell
  yarn gwen init --docker
  ```

</TabItem>

<TabItem value="npm">

Run the following command in the root of your project to generate all the necessary Docker and Selenoid files
  
  ```shell
  npm run gwen init --docker
  ```

</TabItem>

<TabItem value="pnpm">

Run the following command in the root of your project to generate all the necessary Docker and Selenoid files
  
  ```shell
  pnpm gwen init --docker
  ```

</TabItem>

</Tabs>

</TabItem>

</Tabs>

### Dockerfile

```shell {3}
./project                    # Your project root
 └── /gwen
     └──Dockerfile           # Docker image file
```

The init --docker commad will create a `gwen/DockerFile` with the following content to build an Alpine Linux node and Yarn based image with bash and Open JDK 8 JRE installed.

```
# base alpine image with node
FROM node:17-alpine

# install bash and java
RUN apk update \
    && apk add bash \
    && apk add openjdk8-jre

# Run as a non root user
RUN addgroup -S gwen && adduser -S gwen -G gwen -u 4936
USER gwen
```

Should you prefer a Red Hat Linux and Open JDK 8 based image with node and Yarn installed instead, you can change the content to this:
```
# base Red Hat image with open JDK 8
FROM adoptopenjdk/openjdk8:ubi

# install node & yarn
RUN dnf module install nodejs:16 -y
RUN npm install --global yarn

# Run as a non root user
RUN useradd -u 4936 gwen
USER gwen
```

### Docker compose file

```shell {4}
./project                        # Your project root
 └── /gwen
     ├── Dockerfile              # Docker image file
     └── docker-compose.yml      # Docker compose YAML file
```

The init --docker commad will create a `gwen/docker-compose.yml` file with the following content to create containers for Gwen, Chrome, Firefox, and Edge web browsers, a video recorder, and a Selenoid hub that Gwen will connect to.

```yaml
version: '3.5'
services:
  chrome:
    image: selenoid/chrome:latest
    networks:
      - gwen-net
  edge:
    image: browsers/edge:latest
    networks:
      - gwen-net
  firefox:
    image: selenoid/firefox:latest
    networks:
      - gwen-net
  video-recorder:
    image: selenoid/video-recorder:latest-release
    networks:
      - gwen-net
  selenoid:
    image: aerokube/selenoid:latest-release
    networks:
      - gwen-net
    ports:
      - "4444:4444"
    volumes:
      - "$PWD/gwen/browsers:/etc/selenoid/:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "$PWD/gwen/output/.video:/opt/selenoid/video"
    environment:
      - OVERRIDE_VIDEO_OUTPUT_DIR=$PWD/gwen/output/.video
    command: ["-container-network", "gwen-net", "-video-output-dir", "/opt/selenoid/video"]
  gwen:
    depends_on:
      - selenoid
      - video-recorder
      - $GWEN_BROWSER
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SELENIUM_HUB=selenoid
      - NO_COLOR=1
      - GWEN_BROWSER
      - GWEN_DRY_RUN
      - GWEN_PARALLEL
      - GWEN_THREADS
      - GWEN_HEADLESS
      - GWEN_VIDEO
    volumes:
      - "$PWD:/project"
    working_dir: /project
    command: bash -c "yarn install && yarn gwen:selenoid"
    networks:
      - gwen-net
networks:
  gwen-net:
    name: gwen-net
```

Notice that the bash command in the `gwen` container calls out to our `gwen:selenoid` [package JSON script](#package-json-script) we created earlier. If you want to change what Gwen will run in Docker, just change that script!

### Selenoid browsers file

```shell {4}
./project                    # Your project root
 └── /gwen                   # Gwen working directory
     └── /browsers
         └──browsers.json    # Selenoid browsers file
```

The init --docker commad will create a `gwen/browsers/browsers.json` file with the following content that will be used by Selenoid to stand up the browsers in Docker.

```json
{
  "chrome": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "selenoid/chrome:latest",
        "port": "4444",
        "path": "/"
      }
    }
  },
  "MicrosoftEdge": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "browsers/edge:latest",
        "port": "4444",
        "path": "/"
      }
    }
  },
  "firefox": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "selenoid/firefox:latest",
        "port": "4444",
        "path": "/wd/hub"
      }
    }
  }
}
```

### Gwen settings file

```shell {5}
./project                    # Your project root
 └── /gwen                   # Gwen working directory
     └── /browsers
         ├──browsers.json    # Selenoid browsers file
         └──selenoid.conf    # Selenoid Gwen settings
```

The init --docker commad will create a `gwen/browsers/selenoid.conf` file with the following content that will be used by Gwen to connect to Selenoid.

```json
gwen {
  web {
    capability {
      enableVNC = true
      enableVideo = true
    }
    remote {
      url = "http://${env.SELENIUM_HUB}:4444/wd/hub"
    }
  }
}
```

Notice that the our `gwen:selenoid` [package JSON script](#package-json-script) we created earlier loads this configuration through the [-c|--conf](/docs/cli#gwen-cli-options-conf) CLI option.

## Run Gwen in docker

Start your docker desktop (see [getting started with Docker](https://docs.docker.com/get-started/) for more info).

Create the Gwen output directory if it does not already exist.

```shell
mkdir -p gwen/output
```

Run the following command to build your docker image

```shell
docker-compose -f gwen/docker-compose.yml build
```

Run the following command in your project directory launch Gwen on chrome in docker

```shell
GWEN_BROWSER=chrome docker-compose -f gwen/docker-compose.yml run gwen
```

To execute features in parallel (you can pass any number of [environment varaibles](/docs/cli#environment-variables) in this manner)

```shell
GWEN_BROWSER=chrome GWEN_PARALLEL=true docker-compose -f gwen/docker-compose.yml run gwen
```

Tear it all down when done

```shell
GWEN_BROWSER=chrome docker-compose -f gwen/docker-compose.yml down
```

## Video capture

> See also: [Video recordings](/docs/reports/video-recordings) 

If you set the [`GWEN_VIDEO`](/docs/cli#environment-variables) environment variable or the `gwen.web.capability.enableVideo` setting `true` in your `selenoid.conf` file, MP4 video recordings of each session will be attached to the feature level [HTML reports](/docs/reports/html). Set this to `false` if you do not wish to capture video.

File: *gwen/browsers/selenoid.conf*

```json {5}
gwen {
  web {
    capability {
      enableVNC = true
      enableVideo = true
    }
    ..
  }
}
```

:::note video settings
- [`gwen-video.dir`](/docs/settings/reference#gwen-video.dir) 
  - Should match host directory mounted to `/opt/selenoid/video` in Selenoid video-recorder
- [`gwen-video.timeoutSecs`](/docs/settings/reference#gwen-video.timeoutSecs) 
  - Time to wait for asyncronous video writes to complete (override only if default does not suffice)
:::

:::caution Limitation
Since v3.16.0, videos will not be recorded when [parallel execution](/docs/modes/parallel) or [headless browser](/docs/settings/reference#gwen-web-browser-headless) modes are enabled.
:::

## Mac M1 notes

### Chrome or Edge crashes

If you're running Chrome or Edge in a Selenoid docker container on a Mac M1 and encounter the following error

```
(unknown error: DevToolsActivePort file doesn't exist)
```

Make the following changes to the following files and to use the experimanal [Seleniarm](https://github.com/seleniumhq-community/docker-seleniarm) images instead and try again.

File: *gwen/docker-compose.yml*
```yaml {4,8}
version: '3.5'
services:
  chrome:
    image: seleniarm/standalone-chromium:latest
    networks:
      - gwen-net
  edge:
    image: seleniarm/standalone-chromium:latest
    networks:
      - gwen-net
```

File: *gwen/browsers/browsers.json*
```json {6,16}
  {
  "chrome": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "seleniarm/standalone-chromium:latest",
        "port": "4444",
        "path": "/"
      }
    }
  },
  "MicrosoftEdge": {
    "default": "latest",
    "versions": {
      "latest": {
        "image": "seleniarm/standalone-chromium:latest",
        "port": "4444",
        "path": "/"
      }
    }
  }
}
```

The Selenoid video recorder won't work with the experimental Seleniarm images, so you should disable video 

File: *gwen/browsers/selenoid.conf*

```json {5}
gwen {
  web {
    capability {
      enableVNC = true
      enableVideo = false
    }
    remote {
      url = "http://${env.SELENIUM_HUB}:4444/wd/hub"
    }
  }
}
```
